# title

ドメイン駆動設計をはじめよう ―ソフトウェアの実装と事業戦略を結びつける実践技法

# memo

## 1章 設計の基本方針

- ドメイン駆動設計とは、「事業活動の解決したい課題を、そのままソフトウェアの設計に反映させる」という考え方
- 事業活動（ビジネスドメイン）を業務領域（サブドメイン）に分解し、三つのカテゴリー（中核、補完、一般）に分類する
  - ビジネスドメイン: 企業が事業活動を展開する領域
    - ex. クロネコヤマトは宅配サービスを提供する
  - サブドメイン: ビジネスドメインの領域全体を細分化したもの
    - ex. 宅配サービスの運用には、配達システムの構築、配達する人の採用、運営、宅配する品物の管理 ... などのタスクに分けられる。
- 中核の業務領域（Core Subdomain）
  - 競合他社との違いを生み出す業務活動
- 一般的な業務領域（Generic Subdomains）
  - オンライン販売における決済システムなど、競合でも同じシステムを使用するもの
- 補完的な業務領域（Supporting Subdomains）
  - 直接的に利益を生み出すものではないが、中核の業務領域に必要不可欠なもの

## 2章 業務知識を発見する

## 3章 事業活動の複雑さに立ち向かう

## 4章 区切られた文脈どうしの連係
この章では、区切られた文脈どうしの関係を明確にし、うまく連係するためのドメイン駆動設計の考え方とやり方を学びます

## 5章 単純な業務ロジックを実装する

- トランザクションスクリプト
  - 処理手続きが成功または失敗のどちらかで終了することを保証する
  - 失敗しても変更した要素をrollbackしてデータの一貫性を保つ、といった考え方
  - トランザクションスクリプトの主な用途は補完的な業務領域
    - 業務ロジックが単純で、ETL的な操作に適している
- アクティブレコード
  - データベースのテーブルまたはビューの1行を表すオブジェクト
  - データベース操作をカプセル化し、データに関連する業務ロジックを持つ
  - アクティブレコードオブジェクトは単純なCRUD操作のメソッドを持つデータ構造

## 6章 複雑な業務ロジックに立ち向かう

- ドメインモデルとは、ロジックとデータの両方を一体化させた、事業活動を表現するオブジェクトモデル
  - 集約、値オブジェクト、業務イベントそして業務サービス => オブジェクトモデルを組み立てるための部品
- 値オブジェクト
  - 業務で扱う値を表現する部品
  - 同じ値を持つオブジェクトは同じものとして扱う
    - IDフィールドは不要
  - フィールドへの変更は、別の値を生成することを意味する
    - 値オブジェクトは不変（イミュータブル）なオブジェクトである
  - 値オブジェクトはデータとロジック（振る舞い）を表現する
  - メソッドは値を操作し、その結果として、新たな値オブジェクトを生成する
- 集約
  - トランザクションの境界を共有するエンティティの階層構造
  - 集約の境界内部のすべてのデータは、集約が表現する業務ロジックを正しく実装するために、強い一貫性を保証する必要がある
  - 集約の状態および集約内部に保持するオブジェクトの状態を変更する方法は、外部に公開したインターフェースを通じた、コマンドの実行のみ
- 業務サービス
  - 業務ロジックの置き場所となる、状態を持たないオブジェクト
    - 集約や値オブジェクトにカプセル化することが不自然な業務ロジックを記述するため
  - 値オブジェクトと集約の境界内部にカプセル化し、それらを部品としてドメインモデルを組み立てる

## 7章 時間軸でモデルを作る

イベント履歴式ドメインモデル

- イベント履歴式ドメインモデルでは、集約の状態変化を一連の業務イベントで表現する
- 集約の最新状態は業務イベントの履歴から投影
- 業務データから深い洞察を得るためにきわめて重要

## 8章 技術方式

- レイヤードアーキテクチャは、技術的な関心事にもとづいて、ソースコードを分解します。この方式は、業務ロジックとデータアクセスの実装を結びつけるため、アクティブレコードベースのシステムに適しています。
- ポートとアダプターは依存関係を逆転させます。つまり、業務ロジックを中心に置き、業務ロジックをすべての基盤コンポーネントから独立させます。このやり方は、ドメインモデルで実装した業務ロジックに適しています。
- CQRSは、同じデータを複数のモデルで表現します。イベント履歴式ドメインモデルにもとづくシステムでは必須です。それ以外にも、複数の永続化モデルを用いる必要があるシステムに利用できる技術方式です。

## 9章 通信
個々のコンポーネントの境界を越え、コンポーネントどうしの連係を実現する方法を検討

この章ではシステムの構成要素（区切られた文脈）を連係するための通信方法を学びました。最初に、モデル変換装置や共用サービスを実装するためのモデル変換のやり方を検討しました。モデル変換を逐次実行するやり方、あるいは、状態の追跡が必要になる複雑なロジックに対応するモデル変換のやり方を見てきました。

　送信箱は、集約が発行する業務イベントを外部に確実に送信する方法です。送信箱を使うことで、他のプロセスに障害が発生しても、業務イベントが必ず送信されることを保証します。

　複数のシステムコンポーネント（区切られた文脈）にまたがる、単純な業務プロセスを実装する方法がサーガです。業務プロセスが複雑な場合の実装方法が、プロセスマネージャーです。どちらの実装方法も、土台となるのは業務イベントへの非同期な応答とコマンド発行の仕組みです。

## 10章 設計の経験則

この章では事業全体、あるいはさまざまな業務領域についての知識をもとに、どのように設計判断するかを学びました。つまり、文脈をどう区切るのが安全か、業務ロジックをどうモデル化するか、そして区切られた文脈の構築にどの技術方式を選択するかの判断です。最後に、議論が白熱しがちな、テスト方針についても触れてみました。事業活動の理解と関係づけて、テスト方針を選択する方法を説明しました。

　設計判断は重要です。しかし、重要なのは、その判断の有効性を継続的に検証することです。次の章では、ソフトウェア設計の次の段階、つまり、設計判断の継続的な発展に焦点を合わせて検討します。

## 11章 設計を進化させる

事業活動の発展に伴う業務領域のさまざまな変化を識別し、それを設計に反映してください。過去の設計判断が、現在の事業方針や業務活動と整合しているかどうかを確認してください。必要であれば、現在の事業方針と一致するように設計を進化させてください。

　組織の変更は、チーム間の意図の伝達と協力関係に大きく影響します。そして区切られた文脈どうしの連係方法に影響します。また事業活動を学ぶ活動に終わりはありません。時間とともに業務知識を増やし、その知識を使って設計方針を検討し、実装レベルの設計判断に活かしてください。

以下を意識することが大事

- 業務領域の機能を拡張することが必要になったら、適切な設計判断をするために、業務領域を小さい単位で識別することを検討
- 「何にでも手を出して、どれもちゃんとできていない」区切られた文脈を作らないでください。区切られた文脈で表現するモデルは、特定の課題を解決することに集中してください。
- 集約はできるだけ小さく設計してください。強い一貫性が必要なデータの範囲を特定する、という経験則を使って、業務ロジックを新しい集約に抽出する可能性を探ってください。

## 12章 イベントストーミング
イベントストーミングとは、業務プロセスのモデルを迅速に作ることを目的に、関係者が集まって、ブレインストーミングスタイルで進めるローテクな手法

ローテクと記載されているが、考え方としては一番面白い章かも

イベントストーミングは、業務プロセスをモデリングするための協調型のワークショップです。業務プロセスのモデルが手に入るだけではなく、知識を共有できることが主な利点です。イベントストーミングが終わる頃には、参加者全員が、業務プロセスの同じメンタルモデルを持ち、同じ言葉を使って対話する第一歩を踏み出していることでしょう。

## 13章 現実世界のドメイン駆動設計

- 新規の開発プロジェクトと同じように、既存システムに取り組むプロジェクトでも、事業活動を詳しく調べるところから始める
  - 自社の事業目標は何か
  - 目標を達成するための事業方針はどうなっているか
  - 事業活動がどのような業務領域に分かれているか
  - それぞれの業務領域のカテゴリーが何であるか など
- そこから明らかになったことを元にして、システム全体の改善方針を検討し、重点的に解決すべき課題を特定します

## 14章 マイクロサービス

## 15章 イベント駆動型アーキテクチャ
イベント駆動型アーキテクチャとは、システムのコンポーネント間で、イベントメッセージを非同期でやりとりする技術方式です

この章では、区切られた文脈の公開インターフェースを設計する時の本質的な側面として、イベント駆動型アーキテクチャを紹介しました。区切られた文脈の境界を越えて通信する以下の3種類のイベントを学びました。

- イベント通知
  - 何か重要な出来事が発生したことを通知
  - 詳細な情報は、受信側が発信元に問い合わせることが必要
- イベントによる状態転送
  - メッセージを使ってデータを非同期に複製する仕組み
  - それぞれのイベントは、ある状態のスナップショットを伝えます。受信側は、ローカルにキャッシュした発信
  - 元のデータを最新に維持するために、このスナップショットを利用できます。
- 業務イベント
  - 発信側の業務領域で発生した出来事（イベント）を表現したメッセージ

## 16章 データメッシュ
分析系データを管理する仕組みとして、データメッシュを学びます。データメッシュがどのように機能し、従来のOLAP系のデータ管理のアプローチとは、どのように違うのかを説明します。そして、最終的には、ドメイン駆動設計とデータメッシュは相互に補完する関係であることを学びます。
